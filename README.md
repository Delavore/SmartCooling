# SmartCooling

# Описание  проекта 

Проект построен на базе микроконтроллера mik32, содержит в себе аналоговый датчик звука, lcd дисплей nokia5110, датчик температуры и влажности DHT11, реле и вентилятор. 
Когда температура превышает заданную, то вентилятор каждые n минут запускается на m минут/секунд. Если вы не хотите ждать заветную прохладу n минут, то вы может хлопнуть в ладоши 2 раза и время сразу же сократится и вентилятор заработает. На дисплей выводится информация о температуре и влажности, а также вспомогательная информация. 

## utilities.c/utilities.h
Данные файлы содержат в себе вспомогательные функции и макросы. 

## dht11_driver.c/dht11_driver.h
Данные файлы содержат в себе две функции: DHT_Get и DHT_GetUsart . Обе функции служат для получения данных с датчика. Результат записывается в массив, который вы передали. Результат состоит из 5 байт. Функция DHT_GetUsart реализует общение с датчиком посредством USART. В некоторых ситуациях это может быть удобнее, однако в данном проекте она не используется, потому что USART принимает неправильные данные, когда программа загружена во FLASH память. Из eeprom функция DHT_GetUsart работает хорошо.

## disp5110_driver.c/disp5110_driver.h
Данные файлы реализуют драйвер для общения с дисплеем nokia5110_PCD8544. Связь происходит через SPI интерфейс (на mik32 я использую SPI1 модуль) и две дополнительные линии: DC и RST. RST - для начала его работы, а DC - для раграничения отправки команд и данных на отрисовку. 

Для инициализации дисплея надо вызвать функцию DISP_Init. Она подтигивает линию RST и посылает команды настройки дисплея. После ее выполнения можно использовать функции отрисовки: DISP_PlayAnim, DISP_DrawInt, DISP_DrawText и функции очистки экрана: DISP_ClearLine и DISP_Clear

## bitmap.c/bitmap.h
Содержат в себе битовые карты для отрисовки анимации, текста и цифр. Данные файлы вспомогательные и нужны только для disp5110_driver.c .h

## init_periphery.c/init_periphery.h
Файлы с инициализацией модулей, а также макросами подключенной перифирии. Функция USART_Init(...) реализована с использованием нескольких параметров, потому что в проекте используются 2 USART модуля: один для датчика DHT11, другой для отладки программы и вывода вспомогательной информации на экран экран. Поэтому в функцию передаются параметры, которые различаются в настройке этих двух USART модулей. 
Функция SPI1_Init(&spi1) принимает указатель на SPI handler и всегда инициализирует его как SPI1 с заранее заданными параметрами.
ADC_Init настраивает АЦП модуль. SystemClock_Config нужна для начальной настройки тактирования системы. GPIO_Init() задает настройку пинов. Обратите внимание, что всегда следует включать тактирование модулей, которые вы используете. Таймеры настраиваются через функции TIMER32_0_Init и TIMER32_2_Init. Таймеры в данной системе играют очень важную роль: они отсчитывают период через который должен работать вентилятор, время самой работы вентилятора и время получения информации с датчика температуры.  

## disp5110_wrapper.c/disp5110_wrapper.h
Содержат в себе функции обертки над hardware функциями и дейсвиями, такие как подтягивание линии к земле и вызов HAL функции.

## main.c
В основном цикле мы запускаем или отключаем вентилятор, детектируем двойной хлопок. Для детектирования хлопка построен следующий алгоритм: получаем хлопок, далее в окне времени не должно быть звуков, далее получаем еще один хлопок, ждем окно времени -> если в окнах не было звука, то хлопок задетектирован. Суммарно обработка занимает 3сек.

# Тестирование
Написаны модульные тесты с использованием фреймворка UNITY для функций из disp5110_driver.c. 
Тесты для bitmap не нужны, потому что там нет функций. В dht11_driver в фукнции DHT_Get я не вызываю никакие функции, кроме delay, работаю только с регистрами, по моему мнению тут UNIT тестами ничего не проверить, данная фукнция идельно подходит, чтобы быть "замоканной". disp5110_wrapper являются идеальными для того, чтобы его функции были "моками". Далее эти моки используются при тестировании disp5110_driver. В файле init_periphery тестировать, по моему мнению, тоже нечего. В utilities никакие функции не имеет смысла тестировать, потому что они построены на регистрах и макросах, в них не вызываются никакие фукнции. 

# Развитие
Данный проект может быть улучшен: добавить датчик движения, который бы детектировал находится ли кто-то в комнате: например если в течении часа датчик не подает сигнал, то в комнате никого нет. Соответственно при отсутствии движения микроконтроллер должен уйти в сон, чтобы экономить энергию. Далее в данном проекте скорее всего надо реорганизовать фукнцию main, сделать ее более "чистой". Добавить взаимодействие с dma, чтобы процессор не занимался перекачкой данных, например при передачи данных на экран.